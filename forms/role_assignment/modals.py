"""
Application modals for role assignment system
"""

import discord
import re
from datetime import datetime, timezone, timedelta
from discord import ui
from utils.config_manager import load_config, has_pending_role_application
from utils.google_sheets import sheets_manager, retry_on_google_error


class MilitaryApplicationModal(ui.Modal):
    """Modal for military service role applications"""
    
    def __init__(self):
        super().__init__(title="–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –≤–æ–µ–Ω–Ω–æ—Å–ª—É–∂–∞—â–µ–≥–æ")
        
        self.name_input = ui.TextInput(
            label="–ò–º—è –§–∞–º–∏–ª–∏—è",
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
            min_length=2,
            max_length=50,
            required=True
        )
        self.add_item(self.name_input)
        
        self.static_input = ui.TextInput(
            label="–°—Ç–∞—Ç–∏–∫",
            placeholder="123-456 (–¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è 5-6 —Ü–∏—Ñ—Ä)",
            min_length=5,
            max_length=7,
            required=True
        )
        self.add_item(self.static_input)
        
        self.rank_input = ui.TextInput(
            label="–ó–≤–∞–Ω–∏–µ",
            placeholder="–û–±—ã—á–Ω–æ: –†—è–¥–æ–≤–æ–π",
            min_length=1,
            max_length=30,
            required=True,
            default="–†—è–¥–æ–≤–æ–π"
        )
        self.add_item(self.rank_input)
        
        self.recruitment_type_input = ui.TextInput(
            label="–ü–æ—Ä—è–¥–æ–∫ –Ω–∞–±–æ—Ä–∞",
            placeholder="–≠–∫—Å–∫—É—Ä—Å–∏—è –∏–ª–∏ –ü—Ä–∏–∑—ã–≤",
            min_length=1,
            max_length=20,
            required=True
        )
        self.add_item(self.recruitment_type_input)
    
    async def on_submit(self, interaction: discord.Interaction):
        """Process military application submission"""
        # Check for pending applications
        config = load_config()
        role_assignment_channel_id = config.get('role_assignment_channel')
        
        if role_assignment_channel_id:
            has_pending = await has_pending_role_application(interaction.client, interaction.user.id, role_assignment_channel_id)
            if has_pending:
                await interaction.response.send_message(
                    "‚ùå **–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏.**\n\n"
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å —Ä–µ—à–µ–Ω–∏—è –ø–æ —Ç–µ–∫—É—â–µ–π –∑–∞—è–≤–∫–µ, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø–æ–¥–∞–≤–∞—Ç—å –Ω–æ–≤—É—é.\n"
                    "–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –ø—É—Ç–∞–Ω–∏—Ü—ã –∏ —É—Å–∫–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.",
                    ephemeral=True
                )
                return
        
        # Validate and format static
        static = self.static_input.value.strip()
        formatted_static = self._format_static(static)
        if not formatted_static:
            await interaction.response.send_message(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Ç–∞—Ç–∏–∫–∞. –°—Ç–∞—Ç–∏–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 5 –∏–ª–∏ 6 —Ü–∏—Ñ—Ä.\n"
                "–ü—Ä–∏–º–µ—Ä—ã: 123456, 123-456, 12345, 12-345, 123 456",
                ephemeral=True
            )
            return
          # Validate recruitment type
        recruitment_type = self.recruitment_type_input.value.strip().lower()
        if recruitment_type not in ["—ç–∫—Å–∫—É—Ä—Å–∏—è", "–ø—Ä–∏–∑—ã–≤"]:
            await interaction.response.send_message(
                "‚ùå –ü–æ—Ä—è–¥–æ–∫ –Ω–∞–±–æ—Ä–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: '–≠–∫—Å–∫—É—Ä—Å–∏—è' –∏–ª–∏ '–ü—Ä–∏–∑—ã–≤'.",
                ephemeral=True
            )
            return
        
        # Check blacklist status for military applications
        blacklist_check = await self._check_blacklist_status(formatted_static)
        if blacklist_check["is_blocked"]:
            await interaction.response.send_message(
                f"### ‚ùå **–î–æ—Å—Ç—É–ø –∫ –ø–æ–¥–∞—á–µ –∑–∞—è–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω ‚Äî –í—ã –≤ –ß—ë—Ä–Ω–æ–º –°–ø–∏—Å–∫–µ!**\n\n"
                f"> **–ü—Ä–∏—á–∏–Ω–∞:** {blacklist_check['reason']}\n"
                f"> **–ß—ë—Ä–Ω—ã–π –°–ø–∏—Å–æ–∫ –≤—ã–¥–∞–ª:** {blacklist_check['officer']}\n"
                f"> **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ):** {blacklist_check['end_date']}",
                ephemeral=True
            )
            return
        
        # Create application data
        application_data = {
            "type": "military",
            "name": self.name_input.value.strip(),
            "static": formatted_static,
            "rank": self.rank_input.value.strip(),
            "recruitment_type": recruitment_type,
            "user_id": interaction.user.id,
            "user_mention": interaction.user.mention
        }
        
        # Send for approval
        await self._send_application_for_approval(interaction, application_data)
    
    def _format_static(self, static_input: str) -> str:
        """Auto-format static number to standard format"""
        digits_only = re.sub(r'\D', '', static_input.strip())
        
        if len(digits_only) == 5:
            return f"{digits_only[:2]}-{digits_only[2:]}"
        elif len(digits_only) == 6:
            return f"{digits_only[:3]}-{digits_only[3:]}"
        else:
            return ""
    
    @retry_on_google_error(retries=3, delay=1)
    async def _check_blacklist_status(self, static_formatted):
        """Check if user is blacklisted based on static number"""
        try:
            # Check if Google Sheets manager is available
            if not sheets_manager:
                print("Google Sheets manager not available")
                return {"is_blocked": False}
            
            # Ensure connection
            if not sheets_manager._ensure_connection():
                print("No Google Sheets connection for blacklist check")
                return {"is_blocked": False}
            
            # Get the '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–ù–ï –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨)' worksheet
            blacklist_worksheet = None
            for worksheet in sheets_manager.spreadsheet.worksheets():
                if worksheet.title == "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–ù–ï –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨)":
                    blacklist_worksheet = worksheet
                    break
            
            if not blacklist_worksheet:
                print("'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–ù–ï –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨)' sheet not found")
                return {"is_blocked": False}
            
            # Get all values from the sheet
            sheet_data = blacklist_worksheet.get_all_values()
            if not sheet_data:
                print("No data found in blacklist sheet")
                return {"is_blocked": False}
            
            # Find records with matching static
            found_records = []
            for row_index, row_data in enumerate(sheet_data):
                # Skip header row and empty rows
                if row_index == 0 or len(row_data) < 6:
                    continue
                
                # Check if column B ends with " | {static_formatted}"
                column_b = str(row_data[1]) if len(row_data) > 1 else ""
                if column_b.endswith(f" | {static_formatted}"):
                    found_records.append((row_index, row_data))
            
            if not found_records:
                return {"is_blocked": False}
            
            # Get the most recent record (smallest row index = closest to top)
            latest_record = min(found_records, key=lambda x: x[0])
            row_data = latest_record[1]
            
            # Parse end date from column E (format: DD.MM.YYYY)
            end_date_str = str(row_data[4]) if len(row_data) > 4 else ""
            if not end_date_str or end_date_str.strip() == "":
                return {"is_blocked": False}
            
            try:
                end_date = datetime.strptime(end_date_str.strip(), "%d.%m.%Y").date()
            except ValueError:
                print(f"Invalid date format in blacklist: {end_date_str}")
                return {"is_blocked": False}
            
            # Get current date in Moscow timezone (UTC+3)
            moscow_tz = timezone(timedelta(hours=3))
            current_date = datetime.now(moscow_tz).date()
            
            if end_date >= current_date:
                # Punishment is still active
                reason = str(row_data[2]) if len(row_data) > 2 else "–ù–µ —É–∫–∞–∑–∞–Ω–∞"
                officer = str(row_data[5]) if len(row_data) > 5 else "–ù–µ —É–∫–∞–∑–∞–Ω"
                
                return {
                    "is_blocked": True,
                    "reason": reason,
                    "officer": officer,
                    "end_date": end_date_str
                }
            else:
                # Punishment has expired
                return {"is_blocked": False}
                
        except Exception as e:
            print(f"Error checking blacklist status: {e}")
            # Fail-safe: allow application submission if there's an error
            return {"is_blocked": False}
    
    async def _send_application_for_approval(self, interaction, application_data):
        """Send application to moderation channel"""
        try:
            config = load_config()
            moderation_channel_id = config.get('role_assignment_channel')
            
            if not moderation_channel_id:
                await interaction.response.send_message(
                    "‚ùå –ö–∞–Ω–∞–ª –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    ephemeral=True
                )
                return
            
            moderation_channel = interaction.guild.get_channel(moderation_channel_id)
            if not moderation_channel:
                await interaction.response.send_message(
                    "‚ùå –ö–∞–Ω–∞–ª –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    ephemeral=True
                )
                return
            
            # Create embed
            embed = discord.Embed(
                title="üìã –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –≤–æ–µ–Ω–Ω–æ—Å–ª—É–∂–∞—â–µ–≥–æ",
                color=discord.Color.blue(),
                timestamp=discord.utils.utcnow()
            )
            
            embed.add_field(name="üë§ –ó–∞—è–≤–∏—Ç–µ–ª—å", value=application_data["user_mention"], inline=False)
            embed.add_field(name="üìù –ò–º—è –§–∞–º–∏–ª–∏—è", value=application_data["name"], inline=True)
            embed.add_field(name="üî¢ –°—Ç–∞—Ç–∏–∫", value=application_data["static"], inline=True)
            embed.add_field(name="üéñÔ∏è –ó–≤–∞–Ω–∏–µ", value=application_data["rank"], inline=True)
            embed.add_field(name="üìã –ü–æ—Ä—è–¥–æ–∫ –Ω–∞–±–æ—Ä–∞", value=application_data["recruitment_type"].title(), inline=True)
            
            # Create approval view
            from .base import create_approval_view
            approval_view = create_approval_view(application_data)
            
            # Get ping roles
            ping_role_ids = config.get('military_role_assignment_ping_roles', [])
            ping_content = ""
            if ping_role_ids:
                ping_mentions = []
                for ping_role_id in ping_role_ids:
                    ping_role = moderation_channel.guild.get_role(ping_role_id)
                    if ping_role:
                        ping_mentions.append(ping_role.mention)
                if ping_mentions:
                    ping_content = f"-# {' '.join(ping_mentions)}"
            
            # Send to moderation channel
            await moderation_channel.send(content=ping_content, embed=embed, view=approval_view)
            
            await interaction.response.send_message(
                "‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –≤–æ–µ–Ω–Ω–æ—Å–ª—É–∂–∞—â–∏–º. –û–∂–∏–¥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è.",
                ephemeral=True
            )
            
        except Exception as e:
            print(f"Error sending military application: {e}")
            await interaction.response.send_message(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                ephemeral=True
            )


class CivilianApplicationModal(ui.Modal):
    """Modal for civilian role applications"""
    
    def __init__(self):
        super().__init__(title="–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –≥–æ—Å—Å–ª—É–∂–∞—â–µ–≥–æ")
        
        self.name_input = ui.TextInput(
            label="–ò–º—è –§–∞–º–∏–ª–∏—è",
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
            min_length=2,
            max_length=50,
            required=True
        )
        self.add_item(self.name_input)
        
        self.static_input = ui.TextInput(
            label="–°—Ç–∞—Ç–∏–∫",
            placeholder="123-456 (–¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è 5-6 —Ü–∏—Ñ—Ä)",
            min_length=5,
            max_length=7,
            required=True
        )
        self.add_item(self.static_input)
        
        self.faction_input = ui.TextInput(
            label="–§—Ä–∞–∫—Ü–∏—è, –∑–≤–∞–Ω–∏–µ, –¥–æ–ª–∂–Ω–æ—Å—Ç—å",
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –§–°–í–ù–ì, –ü–æ–¥–ø–æ–ª–∫–æ–≤–Ω–∏–∫, –ù–∞—á. –£–ø—Ä. –í–Ω–µ–≤–µ–¥–æ–º—Å—Ç–≤–µ–Ω–Ω–æ–π –û—Ö—Ä–∞–Ω—ã",
            min_length=1,
            max_length=100,
            required=True
        )
        self.add_item(self.faction_input)
        
        self.purpose_input = ui.TextInput(
            label="–¶–µ–ª—å –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–∏",
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–ø—É—Å–∫—É (–Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é –≤/—á)",
            min_length=1,
            max_length=100,
            required=True
        )
        self.add_item(self.purpose_input)
        
        self.proof_input = ui.TextInput(
            label="–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (—Å—Å—ã–ª–∫–∞)",
            placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞",
            min_length=5,
            max_length=200,
            required=True
        )
        self.add_item(self.proof_input)
    
    async def on_submit(self, interaction: discord.Interaction):
        """Process civilian application submission"""
        # Check for pending applications
        config = load_config()
        role_assignment_channel_id = config.get('role_assignment_channel')
        
        if role_assignment_channel_id:
            has_pending = await has_pending_role_application(interaction.client, interaction.user.id, role_assignment_channel_id)
            if has_pending:
                await interaction.response.send_message(
                    "‚ùå **–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏.**\n\n"
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å —Ä–µ—à–µ–Ω–∏—è –ø–æ —Ç–µ–∫—É—â–µ–π –∑–∞—è–≤–∫–µ, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø–æ–¥–∞–≤–∞—Ç—å –Ω–æ–≤—É—é.\n"
                    "–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –ø—É—Ç–∞–Ω–∏—Ü—ã –∏ —É—Å–∫–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.",
                    ephemeral=True
                )
                return
        
        # Validate and format static
        static = self.static_input.value.strip()
        formatted_static = self._format_static(static)
        if not formatted_static:
            await interaction.response.send_message(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Ç–∞—Ç–∏–∫–∞. –°—Ç–∞—Ç–∏–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 5 –∏–ª–∏ 6 —Ü–∏—Ñ—Ä.\n"
                "–ü—Ä–∏–º–µ—Ä—ã: 123456, 123-456, 12345, 12-345, 123 456",
                ephemeral=True
            )
            return
        
        # Validate proof URL
        proof = self.proof_input.value.strip()
        if not self._validate_url(proof):
            await interaction.response.send_message(
                "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É –≤ –ø–æ–ª–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤.",
                ephemeral=True
            )
            return
        
        # Create application data
        application_data = {
            "type": "civilian",
            "name": self.name_input.value.strip(),
            "static": formatted_static,
            "faction": self.faction_input.value.strip(),
            "purpose": self.purpose_input.value.strip(),
            "proof": proof,
            "user_id": interaction.user.id,
            "user_mention": interaction.user.mention
        }
        
        # Send for approval
        await self._send_application_for_approval(interaction, application_data)
    
    def _format_static(self, static_input: str) -> str:
        """Auto-format static number to standard format"""
        digits_only = re.sub(r'\D', '', static_input.strip())
        
        if len(digits_only) == 5:
            return f"{digits_only[:2]}-{digits_only[2:]}"
        elif len(digits_only) == 6:
            return f"{digits_only[:3]}-{digits_only[3:]}"
        else:
            return ""
    
    def _validate_url(self, url):
        """Basic URL validation"""
        url_pattern = r'https?://[^\s/$.?#].[^\s]*'
        return bool(re.match(url_pattern, url))
    
    async def _send_application_for_approval(self, interaction, application_data):
        """Send application to moderation channel"""
        try:
            config = load_config()
            moderation_channel_id = config.get('role_assignment_channel')
            
            if not moderation_channel_id:
                await interaction.response.send_message(
                    "‚ùå –ö–∞–Ω–∞–ª –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    ephemeral=True
                )
                return
            
            moderation_channel = interaction.guild.get_channel(moderation_channel_id)
            if not moderation_channel:
                await interaction.response.send_message(
                    "‚ùå –ö–∞–Ω–∞–ª –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    ephemeral=True
                )
                return
            
            # Create embed
            embed = discord.Embed(
                title="üìã –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –≥–æ—Å—Å–ª—É–∂–∞—â–µ–≥–æ",
                color=discord.Color.orange(),
                timestamp=discord.utils.utcnow()
            )
            
            embed.add_field(name="üë§ –ó–∞—è–≤–∏—Ç–µ–ª—å", value=application_data["user_mention"], inline=False)
            embed.add_field(name="üìù –ò–º—è –§–∞–º–∏–ª–∏—è", value=application_data["name"], inline=True)
            embed.add_field(name="üî¢ –°—Ç–∞—Ç–∏–∫", value=application_data["static"], inline=True)
            embed.add_field(name="üèõÔ∏è –§—Ä–∞–∫—Ü–∏—è, –∑–≤–∞–Ω–∏–µ, –¥–æ–ª–∂–Ω–æ—Å—Ç—å", value=application_data["faction"], inline=False)
            embed.add_field(name="üéØ –¶–µ–ª—å –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–∏", value=application_data["purpose"], inline=False)
            embed.add_field(name="üîó –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞", value=f"[–°—Å—ã–ª–∫–∞]({application_data['proof']})", inline=False)
            
            # Create approval view
            from .base import create_approval_view
            approval_view = create_approval_view(application_data)
            
            # Get ping roles
            ping_role_ids = config.get('civilian_role_assignment_ping_roles', [])
            ping_content = ""
            if ping_role_ids:
                ping_mentions = []
                for ping_role_id in ping_role_ids:
                    ping_role = moderation_channel.guild.get_role(ping_role_id)
                    if ping_role:
                        ping_mentions.append(ping_role.mention)
                if ping_mentions:
                    ping_content = f"-# {' '.join(ping_mentions)}"
            
            # Send to moderation channel
            await moderation_channel.send(content=ping_content, embed=embed, view=approval_view)
            
            await interaction.response.send_message(
                "‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –≤–æ–µ–Ω–Ω–æ—Å–ª—É–∂–∞—â–∏–º. –û–∂–∏–¥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è.",
                ephemeral=True
            )
            
        except Exception as e:
            print(f"Error sending civilian application: {e}")
            await interaction.response.send_message(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                ephemeral=True
            )


class SupplierApplicationModal(ui.Modal):
    """Modal for supplier role applications"""
    
    def __init__(self):
        super().__init__(title="–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—Å—Ç–∞–≤–∫–∞–º")
        
        self.name_input = ui.TextInput(
            label="–ò–º—è –§–∞–º–∏–ª–∏—è",
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
            min_length=2,
            max_length=50,
            required=True
        )
        self.add_item(self.name_input)
        
        self.static_input = ui.TextInput(
            label="–°—Ç–∞—Ç–∏–∫",
            placeholder="123-456 (–¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è 5-6 —Ü–∏—Ñ—Ä)",
            min_length=5,
            max_length=7,
            required=True
        )
        self.add_item(self.static_input)
        
        self.faction_input = ui.TextInput(
            label="–§—Ä–∞–∫—Ü–∏—è, –∑–≤–∞–Ω–∏–µ, –¥–æ–ª–∂–Ω–æ—Å—Ç—å",
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –§–°–í–ù–ì, –ü–æ–¥–ø–æ–ª–∫–æ–≤–Ω–∏–∫",
            min_length=1,
            max_length=100,
            required=True
        )
        self.add_item(self.faction_input)
        
        self.proof_input = ui.TextInput(
            label="–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (—Å—Å—ã–ª–∫–∞)",
            placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞",
            min_length=5,
            max_length=200,
            required=True
        )
        self.add_item(self.proof_input)
    
    async def on_submit(self, interaction: discord.Interaction):
        """Process supplier application submission"""
        # Check for pending applications
        config = load_config()
        role_assignment_channel_id = config.get('role_assignment_channel')
        
        if role_assignment_channel_id:
            has_pending = await has_pending_role_application(interaction.client, interaction.user.id, role_assignment_channel_id)
            if has_pending:
                await interaction.response.send_message(
                    "‚ùå **–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏.**\n\n"
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å —Ä–µ—à–µ–Ω–∏—è –ø–æ —Ç–µ–∫—É—â–µ–π –∑–∞—è–≤–∫–µ, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø–æ–¥–∞–≤–∞—Ç—å –Ω–æ–≤—É—é.\n"
                    "–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –ø—É—Ç–∞–Ω–∏—Ü—ã –∏ —É—Å–∫–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.",
                    ephemeral=True
                )
                return
        
        # Validate and format static
        static = self.static_input.value.strip()
        formatted_static = self._format_static(static)
        if not formatted_static:
            await interaction.response.send_message(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Ç–∞—Ç–∏–∫–∞. –°—Ç–∞—Ç–∏–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 5 –∏–ª–∏ 6 —Ü–∏—Ñ—Ä.\n"
                "–ü—Ä–∏–º–µ—Ä—ã: 123456, 123-456, 12345, 12-345, 123 456",
                ephemeral=True
            )
            return
        
        # Validate proof URL
        proof = self.proof_input.value.strip()
        if not self._validate_url(proof):
            await interaction.response.send_message(
                "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É –≤ –ø–æ–ª–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤.",
                ephemeral=True
            )
            return
        
        # Create application data
        application_data = {
            "type": "supplier",
            "name": self.name_input.value.strip(),
            "static": formatted_static,
            "faction": self.faction_input.value.strip(),
            "proof": proof,
            "user_id": interaction.user.id,
            "user_mention": interaction.user.mention
        }
        
        # Send for approval
        await self._send_application_for_approval(interaction, application_data)
    
    def _format_static(self, static_input: str) -> str:
        """Auto-format static number to standard format"""
        digits_only = re.sub(r'\D', '', static_input.strip())
        
        if len(digits_only) == 5:
            return f"{digits_only[:2]}-{digits_only[2:]}"
        elif len(digits_only) == 6:
            return f"{digits_only[:3]}-{digits_only[3:]}"
        else:
            return ""
    
    def _validate_url(self, url):
        """Basic URL validation"""
        url_pattern = r'https?://[^\s/$.?#].[^\s]*'
        return bool(re.match(url_pattern, url))
    
    async def _send_application_for_approval(self, interaction, application_data):
        """Send application to moderation channel"""
        try:
            config = load_config()
            moderation_channel_id = config.get('role_assignment_channel')
            
            if not moderation_channel_id:
                await interaction.response.send_message(
                    "‚ùå –ö–∞–Ω–∞–ª –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    ephemeral=True
                )
                return
            
            moderation_channel = interaction.guild.get_channel(moderation_channel_id)
            if not moderation_channel:
                await interaction.response.send_message(
                    "‚ùå –ö–∞–Ω–∞–ª –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    ephemeral=True
                )
                return
            
            # Create embed
            embed = discord.Embed(
                title="üì¶ –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—Å—Ç–∞–≤–∫–∞–º",
                color=discord.Color.orange(),
                timestamp=discord.utils.utcnow()
            )
            
            embed.add_field(name="üë§ –ó–∞—è–≤–∏—Ç–µ–ª—å", value=application_data["user_mention"], inline=False)
            embed.add_field(name="üìù –ò–º—è –§–∞–º–∏–ª–∏—è", value=application_data["name"], inline=True)
            embed.add_field(name="üî¢ –°—Ç–∞—Ç–∏–∫", value=application_data["static"], inline=True)
            embed.add_field(name="üèõÔ∏è –§—Ä–∞–∫—Ü–∏—è, –∑–≤–∞–Ω–∏–µ, –¥–æ–ª–∂–Ω–æ—Å—Ç—å", value=application_data["faction"], inline=False)
            embed.add_field(name="üîó –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞", value=f"[–°—Å—ã–ª–∫–∞]({application_data['proof']})", inline=False)
            
            # Create approval view
            from .base import create_approval_view
            approval_view = create_approval_view(application_data)
            
            # Get ping roles
            ping_role_ids = config.get('supplier_role_assignment_ping_roles', [])
            ping_content = ""
            if ping_role_ids:
                ping_mentions = []
                for ping_role_id in ping_role_ids:
                    ping_role = moderation_channel.guild.get_role(ping_role_id)
                    if ping_role:
                        ping_mentions.append(ping_role.mention)
                if ping_mentions:
                    ping_content = f"-# {' '.join(ping_mentions)}"
            
            # Send to moderation channel
            await moderation_channel.send(content=ping_content, embed=embed, view=approval_view)
            
            await interaction.response.send_message(
                "‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –≤–æ–µ–Ω–Ω–æ—Å–ª—É–∂–∞—â–∏–º. –û–∂–∏–¥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è.",
                ephemeral=True
            )
            
        except Exception as e:
            print(f"Error sending supplier application: {e}")
            await interaction.response.send_message(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                ephemeral=True
            )


class RoleRejectionReasonModal(ui.Modal, title="–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞"):
    """Modal for requesting rejection reason when rejecting role applications"""
    
    reason_input = ui.TextInput(
        label="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞:",
        placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏",
        style=discord.TextStyle.paragraph,        min_length=0,
        max_length=500,
        required=True
    )
    
    def __init__(self, callback_func, *args, **kwargs):
        super().__init__()
        self.callback_func = callback_func
        self.callback_args = args
        self.callback_kwargs = kwargs
    
    async def on_submit(self, interaction: discord.Interaction):
        try:
            reason = self.reason_input.value.strip()
            
            # Call the callback function with rejection reason
            if self.callback_func:
                await self.callback_func(interaction, reason, *self.callback_args, **self.callback_kwargs)
                
        except Exception as e:
            print(f"Error in RoleRejectionReasonModal: {e}")
            # Check if we already responded to avoid errors
            if not interaction.response.is_done():
                await interaction.response.send_message(
                    "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞.",
                    ephemeral=True
                )
            else:
                await interaction.followup.send(
                    "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞.",
                    ephemeral=True
                )
    
    async def on_error(self, interaction: discord.Interaction, error: Exception):
        print(f"RoleRejectionReasonModal error: {error}")
        try:
            if not interaction.response.is_done():
                await interaction.response.send_message(
                    "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    ephemeral=True
                )
            else:
                await interaction.followup.send(
                    "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    ephemeral=True
                )
        except Exception as follow_error:
            print(f"Failed to send error message in RoleRejectionReasonModal.on_error: {follow_error}")
