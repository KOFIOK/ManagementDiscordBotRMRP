# Новая система управления должностями

## Обзор
Иерархическая система управления должностями с пагинацией, поддерживающая более 300 должностей через навигацию по подразделениям.

## Архитектура

### Основные компоненты
- **`PositionService`** - сервисный слой для работы с базой данных
- **`PositionNavigationView`** - навигация по подразделениям
- **`PositionManagementView`** - управление должностями в подразделении
- **`PositionDetailedView`** - детальное управление отдельной должностью
- **`PositionSearchView`** - поиск и фильтры должностей

### Структура файлов
```
forms/settings/positions/
├── __init__.py              # Экспорт основных компонентов
├── navigation.py            # Навигация по подразделениям
├── management.py            # Управление должностями
├── detailed_management.py   # Детальное управление
├── search.py                # Поиск и фильтры
├── ui_components.py         # Переиспользуемые UI компоненты
├── validation.py            # Валидация данных
├── integration_test.py      # Интеграционные тесты
└── test_*.py               # Модульные тесты
```

## Схема базы данных

### Основные таблицы
- **`positions`** - справочник должностей
- **`subdivisions`** - справочник подразделений
- **`position_subdivision`** - связь должностей с подразделениями

### Связи
```
positions (id) ←→ position_subdivision (position_id)
subdivisions (id) ←→ position_subdivision (subdivision_id)
```

## Использование

### Основной поток
1. **Выбор подразделения** - пользователь выбирает подразделение из списка
2. **Пагинация должностей** - система показывает должности выбранного подразделения с пагинацией
3. **Управление должностью** - пользователь может настроить роль Discord для должности
4. **Добавление должностей** - модераторы могут добавлять новые должности в подразделения

### API PositionService

```python
from utils.database_manager import position_service

# Получить должности подразделения
positions = position_service.get_positions_for_subdivision(subdivision_id)

# Добавить должность
success, message = position_service.add_position_to_subdivision(
    "Название должности", subdivision_id, role_id
)

# Получить все должности со связями
all_positions = position_service.get_all_positions_with_subdivisions()
```

## Интеграция

### В настройки бота
Система интегрирована в основной интерфейс настроек:
- **Путь**: Настройки → Роли должностей
- **Компонент**: `PositionNavigationView`

### Регистрация в Discord
```python
# В app.py on_ready()
from forms.settings.positions import PositionNavigationView

# Регистрация для persistent views
bot.add_view(PositionNavigationView())
```

## Особенности

### Пагинация
- **Подразделения**: до 25 на страницу (ограничение Discord)
- **Должности**: до 25 на страницу
- **Навигация**: кнопки "Предыдущая/Следующая"

### Валидация
- Проверка уникальности названий в подразделении
- Валидация существования подразделений
- Проверка корректности Discord ролей

### Кеширование
- Автоматическая инвалидация кеша при изменениях
- TTL: 5 минут
- Оптимизация запросов к БД

## Тестирование

### Интеграционные тесты
```bash
cd forms/settings/positions
python integration_test.py
```

### Модульные тесты
```bash
python test_position_service.py
python test_infrastructure.py
```

## Миграция с старой системы

### Что изменилось
- **Старая система**: `position_manager` с таблицей `user_data`
- **Новая система**: `position_service` с правильной схемой `employees`

### Автоматическая миграция
Система автоматически работает с новой схемой БД. Старые данные остаются доступными через `PersonnelManager`.

## Производительность

### Оптимизации
- **Connection pooling**: переиспользование соединений PostgreSQL
- **Кеширование**: уменьшение запросов к БД
- **Пагинация**: ограничение количества элементов на странице

### Метрики
- **Время ответа**: < 200ms для типичных операций
- **Память**: минимальное потребление благодаря кешированию
- **БД**: оптимизированные запросы с индексами

## Безопасность

### Валидация ввода
- Проверка всех входных данных
- Защита от SQL-инъекций через параметризованные запросы
- Валидация Discord ID и ролей

### Аудит
- Все изменения логируются через `audit_logger`
- Отслеживание действий модераторов
- История изменений должностей

## Расширение

### Добавление новых функций
1. Создать новый компонент в `forms/settings/positions/`
2. Добавить экспорт в `__init__.py`
3. Обновить навигацию при необходимости
4. Добавить тесты

### Кастомизация UI
- Использовать `ui_components.py` для переиспользуемых элементов
- Соблюдать стиль Discord (эмодзи, цвета, layout)
- Поддерживать responsive design

## Troubleshooting

### Распространенные проблемы
1. **Import errors**: проверить `sys.path` и структуру папок
2. **Database errors**: проверить подключение PostgreSQL
3. **Discord limits**: соблюдать ограничения на 25 элементов в select

### Логи
- Все ошибки логируются с эмодзи префиксами
- Подробные traceback для отладки
- Аудит всех операций с должностями</content>
<parameter name="filePath">g:\GitHub\repos\army discord bot\forms\settings\positions\README.md